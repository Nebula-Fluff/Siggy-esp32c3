# **Siggy project**

## 没兴趣了，暂时不搞了

## **1\. 简述 (Brief Overview)**

本项目是基于 ESP32C3 平台的固件，代号为 **Siggy**，主要目标是实现一个安全的、基于挑战-响应（Challenge-Response）机制的设备身份认证服务。Siggy 通过串口（UART）与一个外部验证设备（在代码中称为“veri”）进行通信，并利用 Ed25519 签名算法来证明自己的身份，以抵抗伪造。

**核心特性：**

1. **安全密钥派生：** 采用 HMAC 机制，结合存储在 ESP32C3 eFuse 中的不可见密钥和固件内的种子，动态派生出 Ed25519 私钥，实现私钥“不在固件中存放”的安全目标。  
2. **挑战-响应机制：** 响应验证方发送的随机数挑战，将挑战数据与设备 ID 结合后签名，回传给验证方进行验证。  
3. **硬件接口：** 使用 UART1 进行数据通信；使用 GPIO 控制红/绿 LED 指示状态；使用 I2C 驱动 SSD1306 OLED 屏幕显示状态和 ID 信息。  
4. **安全模式：** 具备错误计数器和“L O C K D O W N”安全机制，防止密钥派生失败或签名失败被恶意利用。

## **2\. 通讯协议 (Communication Protocol)**

Siggy 与 Verifier 之间的通信基于 UART，采用固定长度的数据包和特定的命令字。

### **协议结构 (通用)**

| 字段 | 长度 (字节) | 值 (HEX) | 说明 |
| :---- | :---- | :---- | :---- |
| **包头** | 2 | 0xA5 0x5A | 所有数据包的起始标识 (PACKET\_HEADER) |
| **命令** | 1 | 见下方 | 指示操作类型 |
| **数据** | 变长 | 见下方 | 负载内容 (挑战数据、签名数据等) |

### **阶段一：Siggy 准备就绪 (TX \- 固件启动)**

Siggy 启动完成后，向 Verifier 发送的信号。

| 字段 | 长度 (字节) | 值 (HEX) | 说明 |
| :---- | :---- | :---- | :---- |
| 包头 | 2 | 0xA5 0x5A |  |
| 命令 | 1 | 0x00 | 命令 0 (COMMAND0)：Siggy 准备好了 |
| **总长** | **3** |  | (READY\_PACKET) |

### **阶段二：Verifier 挑战 (RX \- 接收)**

Verifier 向 Siggy 发起身份认证请求，并附带签名挑战。

| 字段 | 长度 (字节) | 值 (HEX) | 说明 |
| :---- | :---- | :---- | :---- |
| 包头 | 2 | 0xA5 0x5A |  |
| 命令 | 1 | 0x01 | 命令 1 (COMMAND1)：请求 ID，并附带挑战 |
| 随机数挑战 | 32 | 任意值 | 用于防止重放攻击的随机数 (RND\_LEN) |
| **总长** | **35** |  | (RX\_PACKET\_LEN) |

### **阶段三：Siggy 签名响应 (TX \- 发送)**

Siggy 对挑战的响应，包含签名和签名所需的原始数据。

| 字段 | 长度 (字节) | 值 (HEX) | 说明 |
| :---- | :---- | :---- | :---- |
| 包头 | 2 | 0xA5 0x5A |  |
| 命令 | 1 | 0x10 | 命令 10 (COMMAND1\_0)：Siggy ID 及签名回应 |
| Ed25519 签名 | 64 | 签名结果 | 使用私钥对签名数据段的签名 |
| **签名数据段** | **38** |  | **签名后的原始数据（见下方）** |
| **总长** | **105** |  | (SEND\_PACKET\_LEN) |

#### **签名数据段 (38 字节)**

此段内容就是 Siggy 使用私钥签名的原始信息。

| 字段 | 长度 (字节) | 值 (HEX) | 说明 |
| :---- | :---- | :---- | :---- |
| 控制位 | 1 | 0x10 | 命令 10 (COMMAND1\_0) |
| 随机数挑战 | 32 | 接收到的挑战 | Verifier 原始发送的 32 字节随机数 |
| 设备 ID | 5 | FF00000001 | Siggy 的唯一 ID (DEVICE\_ID) |
| **签名数据段总长** | **38** |  | (TO\_SIGN\_ID\_PART\_LEN) |

## **3\. 技术细节 (Technical Details)**

### **A. 安全密钥派生与管理**

这是 v2.0 版本的核心安全升级点。私钥不再硬编码或存储在非易失性存储器中，而是动态派生。

1. **种子定义：** 固件中定义了一个常量字符串 seed\_sk 作为种子："Siggy-1-SEED-NebulaFluff" (25 字节)。  
2. **私钥派生：** 在 send\_id 函数中，调用 esp\_hmac\_calculate(HMAC\_KEY4, seed\_sk, seed\_sk\_len, key\_pair)。  
   * HMAC\_KEY4：**关键点**，这指的是 ESP32C3 硬件加密单元中，一个只有硬件能访问、不可见的 HMAC 密钥（存储在 eFuse 中）。  
   * **结果：** HMAC 运算的结果（32 字节）被存入 key\_pair 数组的前 32 字节，这 32 字节即为 Ed25519 **私钥**。  
3. **密钥对构建：** 紧接着，将硬编码的 32 字节 **公钥** (pk) 复制到 key\_pair 的后 32 字节，形成一个 64 字节的密钥对 (Private Key || Public Key)，供 Ed25519 签名函数使用。  
4. **安全清零：** 签名完成后，立即调用 secure\_zero(key\_pair, KEY\_PAIR\_LEN) 将密钥对内存区域擦除，防止私钥信息残留在内存中被泄露。

### **B. 认证流程和数据走向**

1. **初始化：** Siggy 启动，初始化 UART、GPIO 和 OLED 屏幕，并发送 0xA5 0x5A 0x00 (Ready Packet) 告知 Verifier 已准备就绪。  
2. **接收挑战：** 在主循环中，Siggy 等待接收 35 字节的数据包。如果接收成功且包头正确 (0xA5 0x5A)，则进入 process\_data。  
3. **验证命令：** 在 process\_data 中，检查命令字节是否为 0x01 (Command 1)。如果是，则提取其中的 32 字节随机数挑战，并调用 send\_id(rnd\_in)。  
4. **构建签名数据：** 在 send\_id 中，Siggy 构造 38 字节的待签名数据 (to\_sign\_data)：  
   * \[0x10\] \+ \[32 字节挑战随机数\] \+ \[5 字节设备 ID: FF00000001\]  
5. **签名操作：**  
   * 首先进行 HMAC 派生私钥（如 A 节所述）。  
   * 调用 crypto\_sign(signed\_data, ..., to\_sign\_data, ..., key\_pair) 对 38 字节数据进行 Ed25519 签名。  
6. **发送响应：** 签名成功后，构建 105 字节的最终响应包并发送给 Verifier。  
7. **状态指示和安全退出：**  
   * **签名成功：** 点亮绿色 LED (LED\_GREEN\_GPIO) 并短暂显示 "Sig OK\!"。  
   * **HMAC/签名失败：** 点亮红色 LED (LED\_RED\_GPIO)。  
   * **HMAC 失败计数：** 如果 HMAC 失败达到 2 次 (error\_count \>= 2)，设备将进入不可恢复的 **L O C K D O W N** 状态，持续在 OLED 上闪烁错误信息，并保持红色 LED 点亮。

### **C. 硬件/环境配置**

| 组件 | 配置/引脚 | 作用 |
| :---- | :---- | :---- |
| **UART 端口** | UART\_NUM\_1 | 串口号，用于通信 |
| **UART 波特率** | 115200 | 通讯速率 |
| **OLED (I2C)** | SCL=GPIO5, SDA=GPIO4 | 显示状态和 ID 信息 (ssd1306.h 库) |
| **绿色 LED** | GPIO19 | 积极状态指示 (签名成功) |
| **红色 LED** | GPIO18 | 消极状态指示 (签名/HMAC 失败，或锁定) |
| **ID** | FF00000001 | 设备硬编码 ID |
| **公钥** | 硬编码 32 字节 | 用于 Verifier 验证的 Ed25519 公钥 |
| **加密库** | tweetnacl.h | 负责 Ed25519 签名操作 |
| **派生库** | esp\_hmac.h | 负责安全 HMAC 密钥派生操作 |
| **清零函数** | secure\_zero | 安全擦除内存中的私钥 |

**功能测试验证 (示例输入)：**

* **输入 (RX):** A55A0171776572747975696F706173646667686A6B6C7A786376626E6D717765727479 (35 字节)  
  * Header: A5 5A  
  * Command: 01  
  * Challenge: 71776572747975696F706173646667686A6B6C7A786376626E6D717765727479 (32 字节)  
* **Siggy 待签名数据 (38 字节):**  
  * \[0x10\] \+ \[32 字节 Challenge\] \+ \[0xFF 0x00 0x00 0x00 0x01\]  
* **输出 (TX):** 105 字节数据包  
  * Header: A5 5A  
  * Command: 10  
  * **接下来的 64 字节**：Ed25519 签名  
  * **接下来的 38 字节**：待签名数据（即 \[10\] \[Challenge\] \[ID\]）  

* **Verifier 操作：** Verifier 取出签名和签名数据，使用 Siggy 的公钥 (pk) 验证其真实性。
